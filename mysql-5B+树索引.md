# MySQL-5 B+树索引

## 索引
简单来说就是给所有的页建立一个目录，这个目录里包括用户记录里最小的主键值+页号。


innodb里的索引：复用了之前存储用户记录的数据页来存储目录项，只不过只有两个列：主键和页号，头信息里的record_type的值为1，

一般情况下，用到的B+树都不会超过**4层**

### 聚簇索引
具有2个特点:

* 使用记录主键值的大小进行记录和页的排序
	* 页内的记录是按照主键的大小顺序排成一个单向链表
	* 各个存放用户记录的页也是根据页中用户记录的主键大小顺序排成一个双向链表
	* 存放目录项记录的页分为不同的层次，在同一层次中的页也是根据页中目录项记录的主键大小顺序排成一个双向链表

* B+树的叶子节点存储的是完整的用户记录（所有列的值）

在innodb存储中，聚簇索引就是数据的存储方式，索引即数据，数据即索引。

### 二级索引(辅助索引)
和聚簇索引的不同之处：拿c2列举例
* 使用记录c2列的大小进行记录和页的排序
	* 页内的记录是按照c2列的大小顺序排成一个单向列表
	* 存放用户记录的页是根据c2列大小顺序排成一个双向列表
	* 存放目录项记录的页分为不同的层次，在同一层次中的页也是根据页中记录的c2大小顺序排成一个双向链表

* B+树的叶子节点存储的是c2列+主键这两个列的值
* 目录项记录中变成了c2列+页号的搭配	 
 
按c2列的值找到完整的用户记录后仍然需要到聚簇索引中再查找一边，即`回表`。 

### 联合索引
同时给多个列建立索引，如先把各个记录和页按照c2列进行排序，在记录的c2列相同的情况下，采用c3列进行排序。

本质上也是一个二级索引，只会建立1棵B+树。

### myisam中的索引
* 将表中的记录按照记录的插入顺序单独存储在一个文件中，称之为`数据文件`
* 把索引信息另外存储到索引文件，是`主键值+行号`的组合
* myisam中建立的索引都是二级索引。

## 索引适用的条件
### 全值匹配
搜索条件中的列和索引列一致

### 匹配最左边的列
在搜索语句中只包含左边的就行，或包含多个左边的列，不能跳过1个用后续的。
如果想使用联合索引中尽可能多的列，搜索条件中的各个列必须是联合索引中从最左边连续的列

### 匹配列前缀 like aa%
为某个列建立索引的意思其实就是在对应的B+树的记录中使用`该列的值`进行排序，字符串排序的本质是比较哪个字符串，其实用到了该列的字符集和比较规则。

所以只匹配字符串的前缀也是可以用到索引的,如:`like "Aw%"`，但是`like "%As"`这样就用不到了，因为前面的字符串排序不固定。

### 匹配范围值 
所有记录都是按照索引列的值从小到大的顺序排好的，所以查询过程是先找到最小值，再找到最大值，取中间所有的记录。

不过在使用联合索引进行范围查找的时候，如果对多个列同时进行范围查找的话，只有对索引最左边的那个列进行范围查找的时候才能用到索引。

### 精确匹配某一列并范围匹配另外一列

### 用于排序
一般情况下，是把记录都加载到内存中，再用一些排序算法进行排序，有的时候查询的结果集太大可能暂时借助磁盘的空间来存放中间结果，排序操作完成后再把排好序的结果集返回到客户端。在MySQL中，把这种在内存中/磁盘上进行排序的文件统称为文件排序（filesort）,但是如果order by 里用到了索引列，就**有可能**省去在内存/文件中排序的步骤。

对于联合索引来说，order by 子句的的列的顺序必须按照索引列的顺序给出。ps:where条件里顺序会经过优化器，order by 可是要根据用户给的顺序的。


## 用不到索引的情况

### asc desc 混用
对于联合索引，要求各个排序列的排序顺序是一致的

### where 子句中出现非排序使用到的索引列
即where条件中用了非索引列，但是排序中用了索引列，这种情况是用不到索引的

### 排序列包含非同一个索引的列
即用来排序的多个列不是一个索引里的

### 排序列使用了复杂的表达式

### 用于分组


## 回表的代价
在通过二级索引查找数据时，会用`顺序I/O`访问二级索引，使用`随机I/O`访问聚簇索引。
ps：通过二级索引查找到的值是集中分布在一个或几个数据页中，称为顺序IO。但是得到的主键再回表查时不相连的可能性更大，这时就是随机访问了。

所以需要回表的记录越多，使用二级索引的性能就越低。

### 覆盖索引
为了告别回表操作带来的性能损耗，建议：最好在查询列表里只包含索引列。

## 挑选索引

### 为用于搜索、排序或分组的列创建索引

### 考虑列的基数 
指某一列中不重复数据的个数。

### 索引列的类型尽量小
数据类型越小，在查询时进行的比较操作越快，索引占用的存储空间就越少，在一个数据页内疚可以存放更多记录

### 索引字符串值的前缀
即只对当前列的前几个字符串进行索引：
`key idx_name_bir (name(10),birthday,)`就只保留记录的前10个字符的编码。

### 让索引列在表达式中单独出现
即不加函数，也不做运算

### 主键插入顺序
即让主键自增 auto_increment,而不是我们手动插入

### 避免冗余索引



